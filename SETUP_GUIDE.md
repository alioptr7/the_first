#!/usr/bin/env bash

# SETUP GUIDE for Request/Response Network System
# Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø³ÛŒØ³ØªÙ… Ø¯Ø±Ø®ÙˆØ§Ø³Øª/Ù¾Ø§Ø³Ø®

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘  Setup Guide: Request/Response Network System                 â•‘${NC}"
echo -e "${BLUE}â•‘  Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ: Ø³ÛŒØ³ØªÙ… Ø¯Ø±Ø®ÙˆØ§Ø³Øª/Ù¾Ø§Ø³Ø®                        â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

echo -e "${YELLOW}âš ï¸  Important Architecture Notes:${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "1. â­ RESPONSE NETWORK is the PRIMARY/Master network"
echo "   - Contains: Admin users, Elasticsearch, Settings"
echo "   - Database: response_network_db"
echo ""
echo "2. ğŸ“© REQUEST NETWORK is SECONDARY/Replica network"
echo "   - Contains: Read-only user replicas, Request queue"
echo "   - Database: request_network_db"
echo "   - IMPORTS users from Response Network automatically"
echo ""
echo "3. ğŸ”„ Data Flow:"
echo "   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "   â”‚ Response Network (Master)      Request Network (Replica)    â”‚"
echo "   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
echo "   â”‚                                                              â”‚"
echo "   â”‚ [Admin Users] â”€â”€exportâ”€â”€> [latest.json]                      â”‚"
echo "   â”‚      â†“                        â†“ (manual copy)                 â”‚"
echo "   â”‚ [imports/users/] â†â”€â”€â”€â”€â”€â”€ [latest.json]                       â”‚"
echo "   â”‚      â†“ (import)                                              â”‚"
echo "   â”‚ [Users DB] â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚"
echo "   â”‚      â†“                                                       â”‚"
echo "   â”‚                                                              â”‚"
echo "   â”‚ [Requests] â”€â”€exportâ”€â”€> [latest.jsonl]                        â”‚"
echo "   â”‚                             â†“ (manual copy)                  â”‚"
echo "   â”‚ [imports/requests/] â†â”€â”€ [latest.jsonl]                       â”‚"
echo "   â”‚      â†“ (import)                                              â”‚"
echo "   â”‚ [Incoming Requests] â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚"
echo "   â”‚      â†“                                                       â”‚"
echo "   â”‚ [Query Executor] â†’ Elasticsearch                             â”‚"
echo "   â”‚      â†“                                                       â”‚"
echo "   â”‚ [Results] â”€â”€exportâ”€â”€> [latest.jsonl]                         â”‚"
echo "   â”‚                            â†“ (manual copy)                   â”‚"
echo "   â”‚ [imports/results/] â†â”€â”€ [latest.jsonl]                        â”‚"
echo "   â”‚      â†“ (import)                                              â”‚"
echo "   â”‚ [Responses DB] â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚"
echo "   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo ""
echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

echo -e "${GREEN}ğŸ“‹ STEP-BY-STEP SETUP${NC}"
echo ""

echo -e "${BLUE}PHASE 1: Docker Services${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "cd /workspaces/the_first"
echo "docker-compose up -d"
echo ""
echo "â³ Wait for all services to be healthy:"
echo "   docker-compose ps"
echo ""
echo "Expected services:"
echo "   âœ“ response_postgres    (5432) - Main database"
echo "   âœ“ response_redis       (6380) - Cache & Queue"
echo "   âœ“ response_elasticsearch (9200) - Search engine"
echo ""

echo -e "${BLUE}PHASE 2: Response Network Setup${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "âš™ï¸  2.1 Run database migrations:"
echo "    cd response-network/api"
echo "    python -m alembic upgrade head"
echo ""
echo "âš™ï¸  2.2 Create admin user (ONE-TIME SETUP):"
echo "    python create_admin_user.py"
echo ""
echo "âœ… Verify admin user:"
echo "    python check_admin.py"
echo ""

echo -e "${BLUE}PHASE 3: Start Response Network Services${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Terminal 1 - API:"
echo "    cd response-network/api"
echo "    python -m uvicorn main:app --host 0.0.0.0 --port 8000"
echo ""
echo "Terminal 2 - Worker:"
echo "    cd response-network/api"
echo "    python -m celery -A workers.celery_app worker --loglevel=info"
echo ""
echo "Terminal 3 - Beat Scheduler:"
echo "    cd response-network/api"
echo "    python -m celery -A workers.celery_app beat --loglevel=info"
echo ""
echo "ğŸ“ Access Response Network:"
echo "    API: http://localhost:8000/docs"
echo "    Elasticsearch: http://localhost:9200"
echo ""

echo -e "${BLUE}PHASE 4: Request Network Setup${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "âš™ï¸  4.1 Run database migrations:"
echo "    cd request-network/api"
echo "    python -m alembic upgrade head"
echo ""
echo "âš™ï¸  4.2 Initialize request network:"
echo "    python init_setup.py"
echo ""

echo -e "${BLUE}PHASE 5: Start Request Network Services${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Terminal 4 - API:"
echo "    cd request-network/api"
echo "    python -m uvicorn main:app --host 0.0.0.0 --port 8001"
echo ""
echo "Terminal 5 - Worker:"
echo "    cd request-network/api"
echo "    python -m celery -A workers.celery_app worker --loglevel=info"
echo ""
echo "Terminal 6 - Beat Scheduler:"
echo "    cd request-network/api"
echo "    python -m celery -A workers.celery_app beat --loglevel=info"
echo ""
echo "ğŸ“ Access Request Network:"
echo "    API: http://localhost:8001/docs"
echo "    Swagger: http://localhost:8001/api/v1"
echo ""

echo -e "${GREEN}âœ… System is now running!${NC}"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ“Š Services Overview:"
echo ""
echo "  RESPONSE NETWORK (Master)              REQUEST NETWORK (Replica)"
echo "  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "  âœ“ Admin Panel                          âœ“ Request API"
echo "  âœ“ User Management (Primary)            âœ“ User Sync (Read-only replica)"
echo "  âœ“ Elasticsearch                        âœ“ Rate Limiting"
echo "  âœ“ Settings                             âœ“ Request Queue"
echo "  âœ“ Users Exporter                       âœ“ Users Importer"
echo "  âœ“ Results Exporter                     âœ“ Results Importer"
echo "  âœ“ Settings Exporter                    âœ“ Settings Importer"
echo "                                          âœ“ Requests Exporter"
echo "  EXPORT ENDPOINTS:                      IMPORT ENDPOINTS:"
echo "  â€¢ POST /api/v1/admin/exports/users     â€¢ POST /api/v1/admin/imports/requests"
echo "  â€¢ POST /api/v1/admin/exports/results   â€¢ POST /api/v1/admin/imports/results"
echo "  â€¢ POST /api/v1/admin/exports/settings  â€¢ POST /api/v1/admin/imports/settings"
echo ""

echo -e "${YELLOW}ğŸ”„ Automatic Processes:${NC}"
echo ""
echo "  Response Network (Scheduled):"
echo "  â€¢ export_users_to_request_network (every 5 minutes - DELTA sync)"
echo "  â€¢ export_requests_from_request_network (every 2 minutes)"
echo "  â€¢ export_results_to_request_network (every 2 minutes)"
echo "  â€¢ settings_exporter (on changes)"
echo "  â€¢ profile_types_exporter (on changes)"
echo ""
echo "  Request Network (Scheduled):"
echo "  â€¢ import_users_from_response_network (every 1 minute - DELTA sync)"
echo "  â€¢ import_requests_to_response_network (every 30 seconds)"
echo "  â€¢ import_results_from_response_network (every 30 seconds)"
echo "  â€¢ import_settings_from_response_network (every 1 minute)"
echo ""
echo "  Manual Export (On-demand):"
echo "  â€¢ Admin can trigger exports via API endpoint"
echo "  â€¢ POST /api/v1/admin/exports/users (Response Network)"
echo "  â€¢ POST /api/v1/admin/exports/requests (Request Network)"
echo ""

echo -e "${YELLOW}ğŸ”‘ Default Credentials:${NC}"
echo ""
echo "  Username: admin"
echo "  Password: (set during create_admin_user.py)"
echo "  Email: admin@example.com"
echo ""
echo -e "${YELLOW}ğŸ“ Key Export/Import Directories:${NC}"
echo ""
echo "  Response Network Exports:"
echo "  â€¢ response-network/api/exports/users/ (User data for Request Network)"
echo "  â€¢ response-network/api/exports/results/ (Query results for Request Network)"
echo "  â€¢ response-network/api/exports/settings/ (System settings)"
echo ""
echo "  Request Network Imports:"
echo "  â€¢ request-network/api/imports/users/ (Synced admin users)"
echo "  â€¢ request-network/api/imports/settings/ (Synced settings)"
echo ""
echo "  Request Network Exports:"
echo "  â€¢ request-network/api/exports/requests/ (User requests)"
echo ""
echo "  Response Network Imports:"
echo "  â€¢ response-network/api/imports/requests/ (Incoming user requests)"
echo "  â€¢ response-network/api/imports/results/ (Wait, this is export!)"
echo "    Actually: response-network/api/exports/results/"
echo ""

echo -e "${YELLOW}âš ï¸  Common Issues & Solutions:${NC}"
echo ""
echo "1. Users not syncing to Request Network?"
echo "   - Users only sync when CHANGED (DELTA sync, not full sync)"
echo "   - First import always syncs all users"
echo "   - After that, only modified users are exported"
echo "   - Check: response-network/api/exports/users/latest.json exists"
echo "   - Check: request-network/api/imports/users/ directory exists"
echo "   - Check: Celery worker logs for errors"
echo ""
echo "2. Need to force user export now?"
echo "   - Admin can trigger manual export:"
echo "   - POST /api/v1/admin/exports/users (Response Network)"
echo "   - Or use: python -m celery -A workers.celery_app call workers.tasks.users_exporter.export_users_to_request_network"
echo ""
echo "3. Need to force request export from Request Network?"
echo "   - Admin can trigger manual export:"
echo "   - POST /api/v1/admin/exports/requests (Request Network)"
echo ""
echo "4. Need to force result export from Response Network?"
echo "   - Admin can trigger manual export:"
echo "   - POST /api/v1/admin/exports/results (Response Network)"
echo ""
echo "5. Docker containers not connecting?"
echo "   - docker-compose down -v"
echo "   - docker-compose up -d"
echo "   - Check: docker-compose logs -f postgres"
echo ""
echo "6. Database migrations failed?"
echo "   - Check migrations: docker-compose logs -f postgres"
echo "   - Reset migrations: python -m alembic downgrade base"
echo "   - Re-run: python -m alembic upgrade head"
echo ""

echo -e "${BLUE}ğŸ“š Documentation Files:${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "  â€¢ ARCHITECTURE.md - Full system design"
echo "  â€¢ docs/DOCKER_SETUP.md - Docker configuration"
echo "  â€¢ response-network/api/setup/README.md - Response Network setup"
echo "  â€¢ request-network/README_LOCAL_SETUP.md - Request Network setup"
echo ""

echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo "âœ¨ Setup guide complete! Follow the steps above to get started."
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
